<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω CV - HRM</title>
    <link rel="stylesheet" href="../shared/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- APP LAYOUT -->
    <div class="app-layout">
      <!-- SIDEBAR -->
      <aside class="sidebar" aria-label="Main Navigation">
        <div class="sidebar-header">
          <img src="../shared/logo.png" alt="Logo" />
          <div class="logo-text">
            <span style="display: block; font-size: 1.1rem; font-weight: 800"
              >C·ªîNG C√ÅN B·ªò</span
            >
            <span
              style="
                display: block;
                font-size: 0.8rem;
                font-weight: 500;
                color: #94a3b8;
              "
              >HRM SYSTEM</span
            >
          </div>
        </div>

        <nav class="sidebar-nav">
          <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i> Dashboard
          </a>
          <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i> H·ªì s∆° c√° nh√¢n
          </a>
          <a href="cv.html" class="nav-item active" aria-current="page">
            <i class="fas fa-file-alt"></i> Qu·∫£n l√Ω CV
          </a>
          <a href="qualifications.html" class="nav-item">
            <i class="fas fa-graduation-cap"></i> Tr√¨nh ƒë·ªô & B·∫±ng c·∫•p
          </a>
        </nav>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-content" role="main">
        <!-- TOPBAR -->
        <header class="topbar">
          <h2 class="page-title">Qu·∫£n l√Ω CV</h2>
          <div class="user-profile">
            <button
              onclick="logout()"
              class="btn btn-icon btn-outline"
              title="ƒêƒÉng xu·∫•t"
            >
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </header>

        <!-- CONTENT WRAPPER -->
        <div class="content-wrapper">
          <div class="flex items-center gap-3 mb-4">
            <!-- <button
              onclick="window.history.back()"
              class="btn btn-outline btn-icon"
              aria-label="Quay l·∫°i"
            >
              <i class="fas fa-arrow-left"></i>
            </button> -->
            <h1 style="margin: 0; font-size: 1.75rem">QU·∫¢N L√ù CV</h1>
          </div>

          <!-- Upload Section -->
          <div class="card mb-4">
            <div
              class="card-header"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h3 class="card-title">T·∫¢I L√äN CV M·ªöI</h3>
              <a href="create-cv.html" class="btn btn-primary no-underline">
                <i class="fas fa-plus"></i> T·∫°o CV
              </a>
            </div>
            <div class="card-body">
              <div class="upload-area" id="uploadArea">
                <div style="text-align: center">
                  <div style="font-size: 4rem; margin-bottom: var(--space-2)">
                    üìÅ
                  </div>
                  <p
                    style="
                      font-family: var(--font-heading);
                      font-weight: 700;
                      margin-bottom: var(--space-1);
                    "
                  >
                    K√©o th·∫£ file v√†o ƒë√¢y
                  </p>
                  <p
                    style="
                      color: var(--color-gray-700);
                      margin-bottom: var(--space-3);
                    "
                  >
                    ho·∫∑c
                  </p>
                  <input
                    type="file"
                    id="cvFileInput"
                    accept=".pdf,.doc,.docx"
                    style="display: none"
                    onchange="handleFileSelect(event)"
                  />
                  <!-- Hidden Input for Update -->
                  <input
                    type="file"
                    id="updateCVInput"
                    accept=".pdf,.doc,.docx"
                    style="display: none"
                    onchange="handleUpdateCVSelect(event)"
                  />
                  <button
                    class="btn btn-primary"
                    onclick="document.getElementById('cvFileInput').click()"
                  >
                    Ch·ªçn file
                  </button>
                  <p
                    style="
                      font-size: 0.875rem;
                      color: var(--color-gray-700);
                      margin-top: var(--space-2);
                    "
                  >
                    Ch·∫•p nh·∫≠n: PDF, DOC, DOCX (T·ªëi ƒëa 5MB)
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- CV History -->
          <div class="card">
            <div class="card-header">
              <div class="flex justify-between items-center">
                <h3 class="card-title">M·∫™U CV C√ì S·∫¥N</h3>
                <span class="badge" id="cvCountBadge">0 CV</span>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table class="table" id="cvTable">
                  <thead>
                    <tr>
                      <th>T√™n file</th>
                      <th>K√≠ch th∆∞·ªõc</th>
                      <th>Ng√†y t·∫£i l√™n</th>
                      <th>Tr·∫°ng th√°i</th>
                      <th>Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody id="cvTableBody">
                    <tr>
                      <td
                        colspan="5"
                        style="
                          text-align: center;
                          padding: var(--space-4);
                          color: var(--color-gray-700);
                        "
                      >
                        Ch∆∞a c√≥ CV n√†o. H√£y t·∫£i l√™n CV ƒë·∫ßu ti√™n c·ªßa b·∫°n!
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <style>
      .dashboard-container {
        background: var(--color-gray-100);
        min-height: 100vh;
      }

      .upload-area {
        border: 3px dashed var(--color-black);
        padding: var(--space-6);
        background: var(--color-white);
        transition: all var(--transition-base);
      }

      .upload-area:hover {
        background: var(--color-gray-100);
        border-color: var(--color-red);
      }

      .upload-area.drag-over {
        background: var(--color-red);
        color: var(--color-white);
        border-color: var(--color-black);
      }

      .cv-actions {
        display: flex;
        gap: var(--space-1);
      }

      .cv-actions button {
        padding: 4px 8px;
        font-size: 0.75rem;
      }
    </style>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
      requireAuth();

      document.addEventListener("DOMContentLoaded", async () => {
        await loadCVList();
        setupDragAndDrop();

        // Check for AI Suggestion from Redirect
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("new_cv") === "true") {
          // Get latest logic
          const resp = await apiCall("/cv");
          if (resp.data && resp.data.length > 0) {
            // Sort by date desc
            const sorted = resp.data.sort(
              (a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)
            );
            setTimeout(() => askAIExtraction(sorted[0].id), 800);
          }
        }
      });

      // --- AI Extraction Helper ---
      async function askAIExtraction(cvId) {
        if (!cvId) return;

        // Ask for permission first (User Request)
        if (
          !(await showConfirm(
            "‚ú® TR·ª¢ L√ù AI: \n\nB·∫°n c√≥ mu·ªën nh·ªù AI ƒë·ªçc CV n√†y ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin v√†o ph·∫ßn 'Tr√¨nh ƒë·ªô & K·ªπ nƒÉng' kh√¥ng?"
          ))
        ) {
          return;
        }

        try {
          // showToast("ü§ñ AI ƒëang ph√¢n t√≠ch CV...", "info");
          document.body.style.cursor = "wait";

          const res = await apiCall(`/cv/${cvId}/extract-qualifications`, {
            method: "POST",
          });

          // Handle Scanned/Image PDF Warning
          if (res.warning === "NO_TEXT_CONTENT") {
            showToast("‚ö†Ô∏è File scan/·∫£nh: Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung", "warning");
            return;
          }

          if (res.success) {
            const ext = res.data || res.extracted; // Support both for safety
            const count =
              (ext.education ? ext.education.length : 0) +
              (ext.experience ? ext.experience.length : 0) +
              (ext.skills ? ext.skills.length : 0) +
              (ext.achievements ? ext.achievements.length : 0);

            if (count > 0) {
              showToast(
                `‚ú® AI ƒë√£ tr√≠ch xu·∫•t ${count} th√¥ng tin m·ªõi!`,
                "success"
              );

              // Optional: Ask to view
              if (
                await showConfirm(
                  `‚úÖ ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° nƒÉng l·ª±c t·ª´ CV m·ªõi.\n\nB·∫°n c√≥ mu·ªën ki·ªÉm tra k·∫øt qu·∫£ ngay kh√¥ng?`
                )
              ) {
                window.location.href = "qualifications.html";
              }
            } else {
              showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√π h·ª£p trong CV", "info");
            }
          } else {
            showToast(res.message, "error");
          }
        } catch (error) {
          console.error(error);
          showToast(
            `L·ªói: ${error.message || "Kh√¥ng th·ªÉ ph√¢n t√≠ch CV"}`,
            "error"
          );
        } finally {
          document.body.style.cursor = "default";
        }
      }

      function setupDragAndDrop() {
        const uploadArea = document.getElementById("uploadArea");

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          uploadArea.addEventListener(
            eventName,
            () => {
              uploadArea.classList.add("drag-over");
            },
            false
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(
            eventName,
            () => {
              uploadArea.classList.remove("drag-over");
            },
            false
          );
        });

        uploadArea.addEventListener(
          "drop",
          (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              handleFile(files[0]);
            }
          },
          false
        );
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      async function handleFile(file) {
        document.body.style.cursor = "wait";

        try {
          // Validate file
          const validTypes = [
            "application/pdf",
            "application/msword",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          ];
          const maxSize = 5 * 1024 * 1024; // 5MB

          if (!validTypes.includes(file.type)) {
            throw new Error("Ch·ªâ ch·∫•p nh·∫≠n file PDF, DOC, DOCX");
          }

          if (file.size > maxSize) {
            throw new Error("K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB");
          }

          // showToast("ƒêang t·∫£i l√™n CV...", "info");

          const formData = new FormData();
          formData.append("cv", file);

          const data = await apiCall("/cv/upload", {
            method: "POST",
            body: formData,
            isFormData: true,
          });

          showToast("T·∫£i l√™n CV th√†nh c√¥ng!", "success");
          await loadCVList();

          // Reset input
          document.getElementById("cvFileInput").value = "";

          // Suggest AI Extraction (Get latest CV)
          const latestData = await apiCall("/cv");
          if (latestData.data && latestData.data.length > 0) {
            // Sort by date desc
            const sorted = latestData.data.sort(
              (a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)
            );
            setTimeout(() => askAIExtraction(sorted[0].id), 500);
          }
        } catch (error) {
          showToast(error.message || "T·∫£i l√™n th·∫•t b·∫°i", "error");
        } finally {
          document.body.style.cursor = "default";
        }
      }

      async function loadCVList() {
        try {
          const data = await apiCall("/cv");
          const cvList = data.data || [];

          document.getElementById("cvCountBadge").textContent =
            `${cvList.length} CV`;

          const tbody = document.getElementById("cvTableBody");

          if (cvList.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: var(--space-4); color: var(--color-gray-700);">
                                Ch∆∞a c√≥ CV n√†o. H√£y t·∫£i l√™n CV ƒë·∫ßu ti√™n c·ªßa b·∫°n!
                            </td>
                        </tr>
                    `;
            return;
          }

          tbody.innerHTML = cvList
            .map(
              (cv, index) => `
                    <tr>
                        <td>${cv.filename}</td>
                        <td>${formatFileSize(cv.size)}</td>
                        <td>${formatDate(cv.uploadDate)}</td>
                        <td><span class="badge">ƒê√£ t·∫£i l√™n</span></td>
                        <td class="cv-actions">
                            <button class="btn btn-small btn-primary" onclick="viewCV('${
                              cv.id
                            }', '${cv.filename}')">Xem</button>
                            <button class="btn btn-small btn-outline" onclick="downloadCV('${
                              cv.id
                            }', '${cv.filename}')">T·∫£i xu·ªëng</button>
                            <button class="btn btn-small btn-outline" onclick="deleteCV('${
                              cv.id
                            }')">X√≥a</button>
                            <button class="btn btn-small btn-outline" title="C·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi" onclick="triggerUpdateCV('${
                              cv.id
                            }')">C·∫≠p nh·∫≠t</button>
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          console.error("Load CV error:", error);
        }
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      // --- Update CV Logic ---
      let updatingCvId = null;

      function triggerUpdateCV(id) {
        updatingCvId = id;
        document.getElementById("updateCVInput").click();
      }

      async function handleUpdateCVSelect(event) {
        const file = event.target.files[0];
        if (!file || !updatingCvId) return;

        // Validate
        const validTypes = [
          "application/pdf",
          "application/msword",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        ];
        if (!validTypes.includes(file.type)) {
          showToast("Ch·ªâ ch·∫•p nh·∫≠n file PDF, DOC, DOCX", "error");
          return;
        }
        if (
          !(await showConfirm(
            `B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi cho CV n√†y b·∫±ng file "${file.name}"?`
          ))
        ) {
          event.target.value = ""; // Reset
          return;
        }

        // Store cvId before it gets reset
        const cvIdToExtract = updatingCvId;

        try {
          // showToast("ƒêang c·∫≠p nh·∫≠t phi√™n b·∫£n...", "info");
          document.body.style.cursor = "wait";
          const formData = new FormData();
          formData.append("cv", file);

          await apiCall(`/cv/${updatingCvId}`, {
            method: "PUT",
            body: formData,
            isFormData: true,
          });

          showToast("C·∫≠p nh·∫≠t phi√™n b·∫£n th√†nh c√¥ng!", "success");
          await loadCVList();

          // Suggest AI Extraction - using stored cvId
          setTimeout(() => askAIExtraction(cvIdToExtract), 500);
        } catch (e) {
          showToast(e.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i", "error");
        } finally {
          updatingCvId = null;
          document.body.style.cursor = "default";
          event.target.value = ""; // Reset input
        }
      }

      async function downloadCV(cvId, filename) {
        try {
          // showToast("ƒêang t·∫£i xu·ªëng...", "info");

          const response = await fetch(API_BASE_URL + `/cv/${cvId}/download`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("authToken")}`,
            },
          });

          if (!response.ok) throw new Error("Download failed");

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.click();
          window.URL.revokeObjectURL(url);

          showToast("T·∫£i xu·ªëng th√†nh c√¥ng!", "success");
        } catch (error) {
          showToast("T·∫£i xu·ªëng th·∫•t b·∫°i", "error");
        }
      }

      let currentPreviewId = null;
      let currentPreviewName = null;

      function downloadCurrentCV() {
        if (currentPreviewId && currentPreviewName) {
          downloadCV(currentPreviewId, currentPreviewName);
        }
      }

      async function viewCV(cvId, filename) {
        currentPreviewId = cvId;
        currentPreviewName = filename;

        const modal = document.getElementById("previewModal");
        const title = document.getElementById("previewTitle");
        const container = document.getElementById("previewContainer");

        title.textContent = filename;
        container.innerHTML =
          '<div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color: #aaa;"><h3>ƒêang t·∫£i d·ªØ li·ªáu...</h3></div>';

        // Show modal with flex
        modal.style.display = "flex";

        try {
          const response = await fetch(API_BASE_URL + `/cv/${cvId}/view`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("authToken")}`,
            },
          });

          if (!response.ok)
            throw new Error("Server returned " + response.status);

          const blob = await response.blob();
          const objUrl = window.URL.createObjectURL(blob);

          container.innerHTML = "";
          const iframe = document.createElement("iframe");
          iframe.src = objUrl;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.style.background = "#fff";
          container.appendChild(iframe);
        } catch (error) {
          console.error("View CV error:", error);
          container.innerHTML =
            '<div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color: #ea4335;"><h3>Kh√¥ng th·ªÉ t·∫£i b·∫£n xem tr∆∞·ªõc</h3><p>' +
            error.message +
            '</p><br><button class="btn btn-primary" onclick="downloadCurrentCV()">T·∫£i xu·ªëng file g·ªëc</button></div>';
        }
      }

      async function deleteCV(cvId) {
        if (!(await showConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a CV n√†y?"))) return;

        try {
          // showToast("ƒêang x√≥a CV...", "info");
          document.body.style.cursor = "wait";

          await apiCall(`/cv/${cvId}`, {
            method: "DELETE",
          });

          showToast("X√≥a CV th√†nh c√¥ng!", "success");
          await loadCVList();
        } catch (error) {
          showToast(error.message || "X√≥a th·∫•t b·∫°i", "error");
        } finally {
          document.body.style.cursor = "default";
        }
      }
    </script>

    <!-- Dark Theme Preview Modal -->
    <style>
      .preview-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        display: none;
        flex-direction: column;
      }
      .preview-header {
        height: 56px;
        background: #202124;
        display: flex;
        align-items: center;
        padding: 0 16px;
        color: #fff;
        justify-content: space-between;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }
      .preview-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
        flex: 1;
        overflow: hidden;
      }
      .preview-close-btn {
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        color: #e8eaed;
        font-size: 20px;
        transition: background 0.2s;
      }
      .preview-close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .preview-filename {
        font-size: 16px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .preview-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn-preview-download {
        background: #8ab4f8;
        color: #202124;
        border: none;
        padding: 6px 16px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      .btn-preview-download:hover {
        background: #aecbfa;
      }
      .preview-body {
        flex: 1;
        background: #202124;
        overflow: hidden;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>

    <div class="preview-modal-overlay" id="previewModal">
      <div class="preview-header">
        <div class="preview-header-left">
          <div
            class="preview-close-btn"
            onclick="
              document.getElementById('previewModal').style.display = 'none'
            "
            title="ƒê√≥ng"
          >
            ‚úï
          </div>
          <div class="preview-filename" id="previewTitle">T√™n file</div>
        </div>
        <div class="preview-actions">
          <button class="btn-preview-download" onclick="downloadCurrentCV()">
            <span>‚¨á</span> T·∫£i xu·ªëng
          </button>
        </div>
      </div>
      <div class="preview-body" id="previewContainer">
        <!-- Content/Iframe -->
      </div>
    </div>
  </body>
</html>
